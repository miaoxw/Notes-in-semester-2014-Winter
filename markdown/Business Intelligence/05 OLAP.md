#05 联机分析处理OLAP
##一、联机分析处理
###1.从OLTP到OLAP
* 关系数据库模型促进了关系数据库及OLTP的发展
* 数据量从MB、GB级过渡到TB、PB级别

在这样的前提下，兼顾事务操作和分析操作在性能上越来越不可能  
其诞生背景与数据仓库类似
###2.OLAP
通过专门的数据综合引擎，辅以更加直观的数据访问界面，在短时间内相应非数据处理专业人员的复杂查询要求

* OLAP是面向特定问题的联机数据访问和分析  
OLAP是只读的工具，这是与SQL的巨大差异
* 通过对信息多种可能的观察形式进行快速、稳定一致和交互性的存取  
多个“维度”
* 允许决策人员对数据进行深入观察  
以人为主导
####OLAP与OLTP的比较
> 具体内容见ppt第5页
##二、OLAP的特征及衡量标准
###1.Codd关于OLAP的评价准则
* 必须提供多维概念视图  
从多个维度考察对象
* 透明性准则  
OLAP也需要提供接入的接口
	* OLAP在体系结构中的位置对用户透明
	* OLAP的数据源对用户透明
* 存取能力准则  
无论如何，异质的数据都必须组合起来提供单一、完整、连续的用户视图  
*如果OLAP的后台已经使用数据仓库进行支撑，存取能力就自然得到了满足*  
*在关系数据库上建立OLAP并不是不可能的，不过必定会越来越少*
* 稳定的报表功能  
数据量、维度和层次的增加不应使提供报表的能力明显下降
* 客户/服务器体系结构  
必须以在线方式提供服务  
C/S、B/S、P2P等方式皆可
* 维的同等性原则  
多维数据模型在每个维度上应当是均一的  
在维和维的操作上要等同  
*不一定在所有OLAP工具都能满足此要求*
* 动态的稀疏矩阵处理准则  
维度上升后存储效率极具下降，OLAP需要使存储的物理模型适应指定维度  
这种压缩要是透明的
* 多用户支持能力准则  
以分时的方式利用OLAP工具  
同时允许多个用户接入，以联机的方式访问
* 非受限的跨维操作
	* 层次之间的关系应该能够由OLAP自行定义
	* 如果某一维度没有默认定义或默认定义不正确，OLAP需要提供完备的机制进行定义和计算
* 直观的数据操作  
非数据专业处理人员经过简单培训要能完成相应操作
* 灵活的报表生成
* 不受限维与聚集层次  
当然希望无限，不过不可能  
通常要求不少于15个维度的任意聚集层次
###2.FASMI——另一个评价准则
**共享多维度信息的快速存取**

* Fast
* Analysis
* Shared
* Multidimensional
* Information
##三、OLAP中的几个基本概念
###1.度量值
在分析性处理中我们所关心和分析的对象

* 多维数据集中，度量值是一组值  
而且通常为数字值  
对数字值的分析手段最为丰富，客观世界中的指标多以数字表现
* 度量值取决于最终用户请求的信息类型
####常见的度量值
* 销售金额
* 成本金额
* 库存数量
* 消费金额
###2.维度
结合在度量值周围，观察度量值的角度  
*必须要有多个维度*
> ######例：从多个维度观察销售金额度量值
> * 时间维  
> 所有商品在不同时间段内的销售总额
> * 商品维  
> 根据商品分类情况同意每一类商品的销售金额
> * 地域维  
> 按连锁店所在区域统计销售额
###3.层
在单独某一维度上的观察层次  
反映了对度量值的观察深度  
数据量与层次的详尽程度成正比
> ######例：维度的不同层次
> * 时间维  
> 周是不能成为月份下一层的，因为不能从周导出月份（跨月周的存在）
> 	* 日——月——季——年
> 	* 日——周——年
> * 商品维
> 	* 商品价格
> 	* 商品供应商
> 	* 购买商品的顾客信息
> 
> **一切的划分依据为主观的分析需求**
###4.维成员
某一维上的合法取值  
可以是单个值，也可以是单个值的集合（区间）
####多层次维的维成员
* 不同维层次上的取值组合  
1998年、1998年1月、1月、1998年1月1日、1月1日……  
* 某个维层次上的取值  
地域维：江苏、南京……
####多维数组
	{维1,维2,维3,...,维n,变量}
* 变量表示观察的度量值
* 维度表示观察该度量值的角度

本质是定义了一个函数

	F(维1,维2,维3,...,维n)=变量

某些组合可以没有定义，但一定不会存在二值映射
##四、OLAP的数据构造方式
#####多维数组和联机分析处理
r个度量值，m个维度，每个维度n个层次->**r\*n^m种分析结果的可能**  
为了方便快速地查到这些统计分析结果，OLAP就需要解决*数据构造方式*和*基本数据模型*的问题

* ROLAP（Relational OLAP）  
使用二维表形式来模拟多维
* MOLAP（Multi-dimensional OLAP）
	* 使用多维数据库管理系统管理  
	多维数据库采用的基本数据模式就是多维数组
	* “事实表”被表示成多维数组
* 混合联机分析处理  
两种方式同时存在，按需使用
###1.ROLAP与MOLAP的区别
> *从ppt26页起*

* 体系结构的区别  
MOLAP可以直接进行存取，但ROLAP将对多维存取的需求分解成若干个SQL，多维综合引擎将若干个结果集组合后再提供给用户  
* 更多区别见ppt28页  
虽然MOLAP速度快，但也存在**装载速度慢**、**预计算导致数据爆炸**、**维数有限**、**文件大小受限**等问题，因此无法完全取代ROLAP
###2.混合联机分析处理（HOLAP）
* 将MOLAP和ROLAP进行融合  
从而取得高效率
* 大量细节数据丢在RDB中
* 高层次聚集数据存储在MDDB中
* 将RDB的查询结果存储到MDDB
###3.OLAP需解决的问题
* 提高对OLAP数据的访问效率
	* 数据ETL的效率
	* OLAP数据查询效率
	* OLAP数据更新效率
####提高ROLAP处理效率的方式
* 采用物化视图  
在保证在线性能的前提下，尽可能少地存放多维数组的查询结果
* 采用特殊的索引与集簇方式  
加速星形模式内表的连接速度
* 尽量采用并行操作以提高处理速度  
分解不存在相互依赖的计算
* 采用OLAP中的查询优化技术  
共享排序技术
* 采用增量技术
##五、OLAP的基本数据模型
* MOLAP  
多维数据库
* ROLAP  
用**事实表**的二维模型存放度量值，定义大量**外关键字**指向维度
	* 星形模型
	* 雪花模型
###1.MOLAP
* 使用专门的多维数据库来存放所需要的数据
* 数据以多维的方式存放，并且使用多维的方式进行展现
* 多维数组比关系数据表表达更清晰且占用存储小  
*（在处理稠密数据时）*
* 高速的综合速度  
MOLAP适用于需要高速处理的复杂分析
* 维护多维数组需要大量资源
####多维数据库存取
* 经压缩的、类似于数组的对象构成
* 这些对象带有高度压缩的索引及指针结构
* 并非维间的每种维成员组合都对应合理的度量值  
MDDB必须具有高效的稀疏数据处理能力，能略过零元、缺失和重复数据
* 使用多维查询语言MDSQL
###2.ROLAP
* 使用通用数据库存储所需数据
* 适用于处理大量数据
* 低效率
* 现有的关系型数据库已经对OLAP做了很多优化  
并行存储、并行查询、并行数据管理、基于成本的查询优化、位图索引、SQL的OLAP扩展(cube, rollup)……
####星型模式
* 事实表  
存放度量值和外关键字
* 维表  
存放维成员的取值

n维的多维表有一个事实表和n个维表  
增加一个新的维度，就增加一个维表，从而易于扩充

应对多维查询时，依赖标准SQL将事实表与维表进行**连接**与**聚集**

星型模式的优势在于架构一旦确定下来，影响架构的宏观因素就很少，可以以**基本固定的方式**进行优化
####雪花模型
* 对星型模式的扩展  
某些维表并不是单一的平面结构，所有维属性的地位并不等同
* 优点
	* 更加适应人类的理解和观察  
	内在的关联性通过将子维表分列而体现出来
	* 规范化的设计趋势节约存储空间
* 缺点
	* 结构远比星型模式复杂
	* 额外进行的多次连接造成性能损失
	* 即使维数相同，表的结构也可能有很大差异  
	难以优化

实际环境中，雪花模型通常不会使用

#####例外
* 人在设计时，不妨使用雪花模型  
雪花模型到星形模型可以轻易地转化
* 当前的维表独立出的子维表是一个公共维度
* 某些维度的数据量非常大，此时节约空间的考量大于节约时间
####其它扩展模式
* 星座模式  
通过公共维度连接多个星型模式
* 雪暴模式  
通过公共维度连接多个雪花模型
##六、数据立方体
###1.物化模型
* 不同维度的统计性数据可以通过计算得到，但消耗时间太多
* 因此预先计算出一些，放置在新的雪花模型或星形模型中
###2.数据超立方体
* 维数≥4时，无法直观地表现出来
* 通过将数据立方体的排列展现
* 已经超出了人类理解的范围  
因此需要**降维**
* 可能违反了Cord对数据仓库定义的原则
###3.方体格
* n维方体称为基本方体
* 0维方体是最高的抽象，成为定点方体
* 方体格构成数据立方体
####优点
* 可以在二维平面中展现任意维度
* 清晰地展现需要得到某个维度的数据如何计算  
**基本方体永远存在**，因此总能被计算出来
###4.星形网查询模式
在每条射线上表现不同层次，一个闭合多边形就唯一确定了一组层次
###5.数据立方体的物化
####不进行物化
* 只存放最底层的相关数据
* 其它数据现用现算  
数据量不大时不是问题  
一旦数据量增大，时间开销将不可接受
####全物化
* 全部层次和维度的数据存储下来
* 等同于多维数据库，除了存储方法不同
* 空间消耗过大  
n维L层的立方体包含Π(L_i+1)种子方
* 通常只对非常频繁使用的数据使用此方法
####部分物化
* 确定要物化的方体子集  
冰山方体  
	* 物化前的时间开销大的
	* 物化效益大的
	* 对其它子方的计算的帮助大的
* 利用查询处理时物化的方体
* 在装入和刷新时，有效地更新物化方体
###6.Multi-way Array Aggregation
* 将数据集分块，每个块可以恰当地放置在内存中进行计算  
*每个块未必有其实际意义*
* 按照某种顺序将这些块计算出来  
* 在内存中开辟缓存，在计算完成后将其调度出去  
缓存不需要整个投影面的大小，但缓存大小受维度大小顺序影响很大  
*维度的递增顺序需要的缓存最小*
###7.OLAP与数据仓库
在实际环境中，OLAP与数据仓库已经解耦

* 越来越多的其它分析工具出现
* 数据模型具备通用性时，没有问题  
*但是不具备通用性时，将这部分数据给数据仓库维护是不划算的*

可以认为OLAP与数据仓库的数据结构没有差异
##七、多维数据分析
* 以多维形式组织起来、以人为主导的数据处理
* 通过这些操作可以任意地对数据进行查看与处理
###1.切片
只看与该维成员相关的数据  
对应于降维的操作
###2.切块
可以认为是切片的复合操作  
维度可能无法下降，但数据量得以减少
###3.旋转
交换维度的排列顺序，获取全新的呈现方式  
高维的旋转操作会很有用  
交换了某些维度的焦点
###4.上钻
将层次较低的数据集提高层次  
上钻不会变更观察的主体
###5.下钻
上钻的逆操作，降低数据的层次  
**上钻与下钻并不能无限制地进行下去，下界为原子层**
###6.其它操作
* 跨钻  
同步地对多个多维模型进行上钻或下钻  
方便进行多个事实的对比
* 钻透
	* 非常少见的操作
	* 下钻到数据立方体最低细节后，继续细化到数据仓库/数据库的关系型表格
	* 可以发现一些错误
###7.发现驱动的探查
* OLAP工具提供一些视觉方面的辅助  
作为工具的提示
* 即使提示的方式方法再好，也需要以人的方式来处理  
很多偏差是没有意义的
* 提示仅限于单维

虽然提供了多维模型的查询工具，但无法完全解决高维度的查询问题